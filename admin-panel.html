<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel - Projects</title>
  <link rel="stylesheet" href="Admin.css" />
  
  <!-- Swiper.js CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
    <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    form, .project { margin-bottom: 20px; }
    button { margin-right: 10px; }
    .status-btn { margin: 0 4px; }

    /* Project card */
    .project {
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      background: #fafafa;
    }

    /* Swiper carousel */
    .project-swiper {
      width: 100%;
      max-width: 700px;
      height: 350px;
      margin: 15px auto;
      border-radius: 8px;
      overflow: hidden;
      /* background: #fff; */
    }

    .project-swiper img {
      width: 100%;
      height: 100%;
      /* object-fit: cover; */
    }

    /* Swiper arrows */
    .swiper-button-next,
    .swiper-button-prev {
      color: #333;
    }

    /* Swiper pagination */
    .swiper-pagination-bullet {
      background: #333;
    }
  </style>
</head>
<body>
  
  <h1>Admin Project Manager</h1>

  <!-- Project Form -->
  <form id="projectForm">
    <input type="text" id="title" placeholder="Project Title" required /><br/>
    <input type="text" id="description" placeholder="Project Description (use commas to separate points)" required /><br/>
    <input type="file" id="imageFile" accept="image/*" multiple /><br/>
    <select id="status" required>
      <option value="">Select Status</option>
      <option value="upcoming">Upcoming</option>
      <option value="ongoing">Ongoing</option>
      <option value="completed">Completed</option>
    </select><br/>
    <input type="hidden" id="projectId" />
    <button type="submit">Save Project</button>
  </form>

  <h2>Upcoming Projects</h2>
  <div id="upcomingList"></div>

  <h2>Ongoing Projects</h2>
  <div id="ongoingList"></div>

  <h2>Completed Projects</h2>
  <div id="completedList"></div>

  <button onclick="location.href='index.html'" style="padding: 6px 9px; color: #fff; background:#444; border: none; border-radius: 4px; cursor: pointer;">
     Website Page
  </button>

  <!-- Firebase + Swiper -->
  <script type="module">
    import { auth, db, storage } from './firebase.js';
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import {
      collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
    import {
      ref, uploadBytes, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-storage.js";

    // Swiper.js
    import Swiper from "https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.mjs";

    const form = document.getElementById("projectForm");
    const title = document.getElementById("title");
    const description = document.getElementById("description");
    const imageFile = document.getElementById("imageFile");
    const status = document.getElementById("status");
    const projectIdField = document.getElementById("projectId");
    const projectCollection = collection(db, "projects");

    // ✅ Check authentication
    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Access denied. Please login as admin.");
        window.location.href = "login.html"; 
      } else {
        localStorage.setItem("isAdmin", "true");
        loadProjects();
      }
    });

    // ✅ Edit Project
    window.editProject = (id, titleVal, descVal, statusVal) => {
      title.value = titleVal;
      description.value = descVal;
      status.value = statusVal;
      projectIdField.value = id;
      form.querySelector("button").textContent = "Update Project";
    };

    // ✅ Delete Project
    window.deleteProject = async (id) => {
      if (confirm("Are you sure you want to delete this project?")) {
        await deleteDoc(doc(db, "projects", id));
        loadProjects();
      }
    };

    // ✅ Save or Update Project
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const id = projectIdField.value;
      const files = imageFile.files;
      let imageURLs = [];

      try {
        // If editing, keep old images
        if (id) {
          const existingDoc = await getDoc(doc(db, "projects", id));
          if (existingDoc.exists()) {
            imageURLs = existingDoc.data().imageURLs || [];
          }
        }

        // Upload new files if added
        if (files.length > 0) {
          for (let file of files) {
            const storageRef = ref(storage, `projectImages/${Date.now()}_${file.name}`);
            await uploadBytes(storageRef, file);
            const downloadURL = await getDownloadURL(storageRef);
            imageURLs.push(downloadURL);
          }
        }

        const data = {
          title: title.value,
          description: description.value,
          imageURLs: imageURLs,
          status: status.value
        };

        if (id) {
          await updateDoc(doc(db, "projects", id), data);
        } else {
          await addDoc(projectCollection, data);
        }

        form.reset();
        projectIdField.value = "";
        form.querySelector("button").textContent = "Save Project";
        loadProjects();
      } catch (error) {
        alert("Error saving project: " + error.message);
        console.error(error);
      }
    });

    // ✅ Initialize Swipers
    function initSwipers() {
      document.querySelectorAll(".project-swiper").forEach(swiperEl => {
        new Swiper(swiperEl, {
          loop: true,
          navigation: {
            nextEl: swiperEl.querySelector(".swiper-button-next"),
            prevEl: swiperEl.querySelector(".swiper-button-prev"),
          },
          pagination: {
            el: swiperEl.querySelector(".swiper-pagination"),
            clickable: true,
          },
          slidesPerView: 1,
          spaceBetween: 10,
        });
      });
    }

    // ✅ Load projects
    async function loadProjects() {
      const snapshot = await getDocs(projectCollection);
      document.getElementById("upcomingList").innerHTML = "";
      document.getElementById("ongoingList").innerHTML = "";
      document.getElementById("completedList").innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        const descriptionPoints = data.description
          ? `<ul>${data.description.split(",").map(point => `<li>${point.trim()}</li>`).join("")}</ul>`
          : "";

        const div = document.createElement("div");
        div.className = "project";
        div.innerHTML = `
          <h3>${data.title}</h3>
          <p><strong>Status:</strong> ${data.status}</p>
          ${descriptionPoints}
          <div class="swiper project-swiper">
            <div class="swiper-wrapper">
              ${(data.imageURLs || []).map(url => `
                <div class="swiper-slide">
                  <img src="${url}" alt="Project Image" />
                </div>`).join('')}
            </div>
            <div class="swiper-button-next"></div>
            <div class="swiper-button-prev"></div>
            <div class="swiper-pagination"></div>
          </div>
          <button onclick="editProject('${id}', '${data.title.replace(/'/g,"\\'")}', '${data.description.replace(/'/g,"\\'")}', '${data.status}')">Edit</button>
          <button onclick="deleteProject('${id}')">Delete</button>
          <hr/>
        `;

        if (data.status === "upcoming") {
          document.getElementById("upcomingList").appendChild(div);
        } else if (data.status === "ongoing") {
          document.getElementById("ongoingList").appendChild(div);
        } else if (data.status === "completed") {
          document.getElementById("completedList").appendChild(div);
        }
      });

      initSwipers(); // initialize sliders after load
    }
  </script>

  <!-- Swiper.js JS -->
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
</body>
</html>


